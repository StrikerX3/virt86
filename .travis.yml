language: cpp
branches:
  only:
  - master
  - travis-deploy

matrix:
  include:
  - os: linux
    dist: xenial
    compiler: gcc
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - g++-7
    env:
    - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
    - BUILD_CONFIGURATION=Debug
    - VIRT86_COMPILER_NAME=GCC7

  - os: linux
    dist: xenial
    compiler: gcc
    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
        packages:
        - g++-7
    env:
    - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
    - BUILD_CONFIGURATION=Release
    - VIRT86_COMPILER_NAME=GCC7

  - os: osx
    osx_image: xcode10.1
    env:
    - BUILD_CONFIGURATION=Debug
    - VIRT86_COMPILER_NAME=LLVM

  - os: osx
    osx_image: xcode10.1
    env:
    - BUILD_CONFIGURATION=Release
    - VIRT86_COMPILER_NAME=LLVM

before_install:
- eval "${MATRIX_EVAL}"
- VIRT86_ARTIFACT_PATH="${TRAVIS_BUILD_DIR}/build/_artifact"

script:
- mkdir build
- cd build
- mkdir ${VIRT86_ARTIFACT_PATH}
- cp ${TRAVIS_BUILD_DIR}/README.md ${VIRT86_ARTIFACT_PATH}
- cp ${TRAVIS_BUILD_DIR}/LICENSE ${VIRT86_ARTIFACT_PATH}
- cmake .. -DCMAKE_BUILD_TYPE=${BUILD_CONFIGURATION} -DCMAKE_INSTALL_PREFIX=${VIRT86_ARTIFACT_PATH}
- make install
- |
  if [[ -z "${TRAVIS_TAG}" ]]; then
    VIRT86_VERSION=1.0.1-b${TRAVIS_BUILD_NUMBER};
  else
    VIRT86_VERSION=$(echo ${TRAVIS_TAG} | cut -c2-);
  fi
- VIRT86_PACKAGE_NAME=virt86-${VIRT86_VERSION}-${VIRT86_COMPILER_NAME}-x64-${BUILD_CONFIGURATION}.tar.gz
- tar -zcvf ${VIRT86_PACKAGE_NAME} ${VIRT86_ARTIFACT_PATH}
- echo Created package ${VIRT86_PACKAGE_NAME}
- cd ${TRAVIS_BUILD_DIR}

deploy:
  provider: bintray
  file: bintray.json
  user: strikerx3
  key:
    secure: K8Ak0/fNnj/suu5ofoXmhtEijL2DIcK/p6Dp/onNYsYzMsvUCUe4AClPoMYhpGC9kNi18gl965jmNRnIGM/DYxbbueENKFYSUtR7L5SGIEnM67eCl4H2YMcPfh9I5czVIYart1ABmaeUN03rKbu1ZyVg4k4aRrMiKh2xkqj92D9rhOPNPzWBG+GsDd1F1Pd3mwwV5Pfv5Yy4HAjgfckpHR1pMtyxV1U2Y1X4yx+7L5uewOtwpTevILjp7XTH/CofmkuSUMZ0VQ2s0pxmRz76QrdnRay/jbOnRNcfKsh1Kr0rT8vcgA7WazwqfMTV0RmqP2vCws9v83NP9VB3sDZowZdW0uR4NOY4aEUhhIq6xXAJlwm77mXyoDwZYAwd9/5KYOHcwxa1OrW0blvuKzh6lUtfHFUG2J/tO6QHV2JbC3xf7deaYYSkrVG6oQ5KuXWS+aYQ8SAro2dXXBesbzXu/691KDOcvgG1VOpz12vFPq4fjAZQE5EYe2aKiJUrBFJgbt5B5gLWVtNpiCooKaroAv5KvJKXFKr1PC6A8Nhtcev6VaJoUpIkLX9yZkzbkfUzqdRTHJhwOG1bIFxfYoApu4j+ThczHwDWiCwvCo4gKh5y0iqAHNZKpUp5sDv7xznAISMFX25K5z4By9XI7f1a2G+yHQS+LPFJxcItq3HTRDo=
  skip_cleanup: true
  dry_run: false
  on:
    all_branches: true
